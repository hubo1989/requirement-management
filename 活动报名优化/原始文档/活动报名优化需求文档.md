# 活动报名优化需求文档

## 1. 需求概述

优化活动报名流程，调用活动报名接口前，对指定银行活动id的通过银行接口进行校验，校验通过后再调用报名接口。另外在报名时使用通过活动id与拓客行号关联到的最小颗粒度（网点、支行等），作为报名的关联银行ID。

## 2. 需求背景

当前活动报名流程存在以下问题：

- 缺少对银行活动有效性的校验机制
- 报名信息与银行机构的关联不够精确
- 可能导致无效报名或数据不一致的情况

## 3. 功能需求

### 3.1 对接中国银行苏州分行校验接口

#### 3.1.1 校验流程

1. 用户提交活动报名请求
2. 系统获取活动ID和结算卡卡号
3. 活动ID符合中国银行苏州分行范围
4. 调用银行接口进行活动ID校验
5. 根据银行接口返回结果决定是否继续报名流程

#### 3.1.2 银行接口调用

- **接口名称**：苏州分行接口平台接口文档-"一行一市"项目卡号校验接口
- **接口文档**：[苏州分行接口平台接口文档-“一行一市”项目卡号校验接口.md](./相关资源/苏州分行接口平台接口文档-“一行一市”项目卡号校验接口.md)
- **调用方式**：
  1. 首先调用登录接口获取token（外网环境：https://cloud.bankofchina.com/su/apiplatform/manage/userLogin/programLogin.action）
  2. 然后调用业务接口进行卡号校验（外网环境：https://cloud.bankofchina.com/su/prod/apiplatform/api/list/lakala_yhys.action）
  3. 请求方式为GET，在请求header中添加token
- **请求参数**：
  - 认证参数：
    - loginName：lakala
    - loginPass：Password@01!（需使用AES加密）
  - 业务参数：
    - CARDNO：银行卡号
- **响应参数**：
  - code：状态码（200表示成功）
  - success：成功标识（true/false）
  - message：消息提示
  - total：记录总数
  - data：结果数据
    - FLAG：校验结果（1表示符合准入条件，0表示不符合）
    - ROW_ID：记录ID
- **加密处理**：
  - 返回结果采用AES加密
  - 密钥：ZGJiYWE2OGEtNmE2Mi00M2U0LWIxOWMtNDQzODJjY2NhNWEx

#### 3.1.3 校验判断逻辑

- **校验成功**：继续执行报名流程
- **校验失败**：向用户返回失败原因，终止报名流程
- **接口异常**：记录错误日志，向用户返回系统异常提示

#### 3.1.4数据留存

* **调用数据**：对请求参数、返回结果入库保存

### 3.2 银行机构关联优化

#### 3.2.1 最小颗粒度关联

- 根据活动ID与拓客行号的关联关系，确定最小颗粒度的银行机构（网点、支行等）
- 将最小颗粒度机构ID作为报名的关联银行ID
- 确保报名数据与银行机构精确对应

#### 3.2.2 数据映射

- 建立活动ID与银行机构的映射关系表
- 实现拓客行号到最小颗粒度机构的转换逻辑
- 维护机构层级关系数据

## 4. 验收标准

- [ ] 银行接口校验功能正常工作
- [ ] 最小颗粒度机构关联准确
- [ ] 报名流程整体性能满足要求
- [ ] 异常情况处理完善
- [ ] 测试用例全部通过

## 5. 相关文档

- [苏州分行接口平台接口文档-“一行一市”项目卡号校验接口.md](./相关资源/苏州分行接口平台接口文档-“一行一市”项目卡号校验接口.md)
